# =====================================================
# DOCKER COMPOSE - API Service
# =====================================================
# Mô tả: Khởi động API Server + Web Dashboard
#   - REST API endpoints
#   - Web UI dashboard
#   - Kết nối đến Redis & PostgreSQL
#
# Prerequisites: Data Service phải chạy trước
# Cách dùng: docker-compose up -d
# Truy cập: http://localhost:8888
# =====================================================

version: '3.8'

services:
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: api_server
    ports:
      - "${API_PORT:-8888}:8888"
    depends_on:
      - check_data_service
    environment:
      # API Configuration
      API_PORT: ${API_PORT:-:8888}
      
      # Redis Configuration (from Data Service)
      REDIS_ADDR: ${REDIS_ADDR:-redis:6379}
      
      # PostgreSQL Configuration (from Data Service)
      PG_HOST: ${PG_HOST:-postgres}
      PG_PORT: ${PG_PORT:-5432}
      PG_USER: ${PG_USER:-postgres}
      PG_PASSWORD: ${PG_PASSWORD:-postgres123}
      PG_DBNAME: ${PG_DBNAME:-social_insight}
      
      # Kafka Configuration (for future extensions)
      KAFKA_BROKERS: ${KAFKA_BROKERS:-kafka:29092}
      KAFKA_TOPIC: ${KAFKA_TOPIC:-raw_posts}
    networks:
      - api_network
      - social_insight_network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  # ===== HEALTH CHECK SERVICE =====
  check_data_service:
    image: alpine
    entrypoint: /bin/sh
    command: -c "echo 'Waiting for data service to be ready...'"
    networks:
      - api_network
      - social_insight_network

# Networks
networks:
  api_network:
    driver: bridge
  social_insight_network:
    external: true
